<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TESTCASES - RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a; /* slate-900 */
      }

      .search-result-card,
      .section-card {
        background-color: #1e293b; /* slate-800 */
        border: 1px solid #334155; /* slate-700 */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .search-result-card:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      /* Animation for results appearing */
      .search-result-card {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      }
      .search-result-card.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* Loader Animation */
      .loader {
        border-top-color: #6366f1; /* indigo-500 */
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Modal Transitions */
      .modal-enter {
        animation: fadeIn 0.3s ease-out forwards;
      }
      .modal-leave {
        animation: fadeOut 0.3s ease-in forwards;
      }
      .modal-content-enter {
        animation: scaleIn 0.3s ease-out forwards;
      }
      .modal-content-leave {
        animation: scaleOut 0.3s ease-in forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      @keyframes scaleIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes scaleOut {
        from {
          transform: scale(1);
          opacity: 1;
        }
        to {
          transform: scale(0.95);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body class="text-slate-200">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
      <header class="text-center mb-12">
        <h1
          class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 pb-2"
        >
          TESTCASES - RAG
        </h1>
        <p class="text-slate-400 mt-2 text-lg">
          Instantly upload, search, and manage your test cases with AI-powered
          insights.
        </p>
      </header>

      <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="md:col-span-1 space-y-8">
          <section
            id="upload-section"
            class="section-card rounded-xl p-6 shadow-lg"
          >
            <h2
              class="text-2xl font-bold mb-4 text-slate-100 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 mr-3 text-cyan-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              1. Upload Cases
            </h2>
            <form id="upload-form" class="space-y-4">
              <input
                id="file-upload"
                type="file"
                name="file"
                accept=".csv, .xlsx, .xls"
                class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 transition-colors cursor-pointer"
              />
              <button
                type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50"
              >
                Upload and Process
              </button>
            </form>
            <div id="upload-status" class="mt-4"></div>
          </section>

          <section
            id="manage-data-section"
            class="section-card rounded-xl p-6 shadow-lg"
          >
            <h2
              class="text-2xl font-bold mb-4 text-slate-100 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 mr-3 text-cyan-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                />
              </svg>
              2. Manage Data
            </h2>
            <div class="space-y-3">
              <button
                id="show-all-btn"
                class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors"
              >
                Show All Test Cases
              </button>
              <button
                id="delete-all-btn"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors"
              >
                Delete All Test Cases
              </button>
            </div>
            <div id="delete-status" class="mt-4"></div>
          </section>
        </div>

        <div class="md:col-span-2">
          <section
            id="search-section"
            class="section-card rounded-xl p-6 shadow-lg mb-8"
          >
            <h2
              class="text-2xl font-bold mb-4 text-slate-100 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 mr-3 text-cyan-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              3. Find Test Cases
            </h2>
            <form id="search-form" class="flex flex-col sm:flex-row gap-3">
              <input
                id="search-query"
                type="text"
                placeholder="e.g., 'verify invalid login credentials'"
                class="flex-grow bg-slate-700 text-white rounded-lg px-4 py-2.5 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
              />
              <button
                type="submit"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50"
              >
                Search
              </button>
            </form>
          </section>

          <section id="results-section" class="mt-8">
            <div id="loader" class="hidden justify-center items-center py-10">
              <div
                class="loader ease-linear rounded-full border-4 border-t-4 border-slate-600 h-12 w-12"
              ></div>
              <p class="ml-4 text-slate-400">Searching...</p>
            </div>
            <div id="results-container" class="space-y-4"></div>
            <div id="all-test-cases-container" class="space-y-4 hidden"></div>
            <div
              id="no-results"
              class="hidden text-center text-slate-400 mt-6 section-card rounded-xl p-8"
            >
              <p class="font-semibold text-lg">No Results Found</p>
              <p class="mt-2">
                Try a different search query or upload a test case file to get
                started.
              </p>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div
      id="update-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4"
    >
      <div
        id="modal-content"
        class="bg-slate-800 border border-slate-700 rounded-xl p-8 shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-indigo-400">Update Test Case</h2>
          <button
            id="close-modal-btn"
            class="text-slate-400 hover:text-white transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <form id="update-form" class="space-y-4">
          <input type="hidden" id="update-point-id" />
          <div>
            <label
              for="update-feature"
              class="block text-sm font-medium text-slate-300 mb-1"
              >Feature</label
            >
            <input
              type="text"
              id="update-feature"
              class="block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label
              for="update-description"
              class="block text-sm font-medium text-slate-300 mb-1"
              >Test Case Description</label
            >
            <textarea
              id="update-description"
              rows="3"
              class="block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            ></textarea>
          </div>
          <div>
            <label
              for="update-prerequisites"
              class="block text-sm font-medium text-slate-300 mb-1"
              >Pre-requisites</label
            >
            <input
              type="text"
              id="update-prerequisites"
              class="block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label
              for="update-steps"
              class="block text-sm font-medium text-slate-300 mb-1"
              >Steps (Combined)</label
            >
            <textarea
              id="update-steps"
              rows="6"
              class="block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            ></textarea>
          </div>
          <div id="update-status" class="pt-2"></div>
          <div class="flex justify-end gap-4 pt-4">
            <button
              type="button"
              id="cancel-update-btn"
              class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const uploadForm = document.getElementById("upload-form");
      const uploadStatus = document.getElementById("upload-status");
      const searchForm = document.getElementById("search-form");
      const searchQuery = document.getElementById("search-query");
      const resultsContainer = document.getElementById("results-container");
      const loader = document.getElementById("loader");
      const noResults = document.getElementById("no-results");

      const deleteAllBtn = document.getElementById("delete-all-btn");
      const deleteStatus = document.getElementById("delete-status");
      const showAllBtn = document.getElementById("show-all-btn");
      const allTestCasesContainer = document.getElementById(
        "all-test-cases-container"
      );

      const updateModal = document.getElementById("update-modal");
      const modalContent = document.getElementById("modal-content");
      const updateForm = document.getElementById("update-form");
      const cancelUpdateBtn = document.getElementById("cancel-update-btn");
      const closeModalBtn = document.getElementById("close-modal-btn");
      const updatePointId = document.getElementById("update-point-id");
      let lastView = null;

      // --- EVENT LISTENERS ---

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        if (!document.getElementById("file-upload").files?.length) {
          setStatus(
            "Please select a file to upload.",
            "warning",
            "upload-status"
          );
          return;
        }
        setStatus("Processing your file...", "info", "upload-status");
        try {
          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.detail);
          setStatus(result.message, "success", "upload-status");
          uploadForm.reset();
        } catch (error) {
          setStatus(
            `Upload failed: ${error.message}`,
            "error",
            "upload-status"
          );
        }
      });

      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const query = searchQuery.value.trim();
        if (!query) return;

        lastView = "search";
        clearResults();
        loader.classList.replace("hidden", "flex");

        try {
          const response = await fetch("/api/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.detail);
          displayResults(data.results, resultsContainer, true);
        } catch (error) {
          setStatus(
            `Search error: ${error.message}`,
            "error",
            "results-container"
          );
        } finally {
          loader.classList.replace("flex", "hidden");
        }
      });

      deleteAllBtn.addEventListener("click", async () => {
        if (
          !confirm(
            "Are you sure you want to delete ALL test cases? This action cannot be undone."
          )
        )
          return;
        setStatus("Deleting all data...", "info", "delete-status");
        try {
          const response = await fetch("/api/delete-all", { method: "POST" });
          const result = await response.json();
          if (!response.ok) throw new Error(result.detail);
          setStatus(result.message, "success", "delete-status");
          clearResults();
        } catch (error) {
          setStatus(
            `Deletion failed: ${error.message}`,
            "error",
            "delete-status"
          );
        }
      });

      showAllBtn.addEventListener("click", async () => {
        lastView = "all";
        clearResults();
        allTestCasesContainer.classList.remove("hidden");
        allTestCasesContainer.innerHTML = `<p class="text-center text-slate-400">Loading test cases...</p>`;
        try {
          const response = await fetch("/api/get-all");
          const data = await response.json();
          if (!response.ok) throw new Error(data.detail);
          displayAllTestCases(data.test_cases);
        } catch (error) {
          allTestCasesContainer.innerHTML = "";
          setStatus(
            `Failed to load data: ${error.message}`,
            "error",
            "all-test-cases-container"
          );
        }
      });

      // --- UPDATE MODAL LOGIC ---

      document.body.addEventListener("click", (e) => {
        const updateButton = e.target.closest(".update-btn");
        if (updateButton) {
          const testCaseData = JSON.parse(updateButton.dataset.testcase);
          openUpdateModal(testCaseData);
        }
      });

      updateForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const pointId = updatePointId.value;
        const payload = {
          feature: document.getElementById("update-feature").value,
          description: document.getElementById("update-description").value,
          prerequisites: document.getElementById("update-prerequisites").value,
          steps: document.getElementById("update-steps").value,
        };

        setStatus("Updating test case...", "info", "update-status");

        try {
          const response = await fetch(`/api/update/${pointId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.detail);

          setStatus("Update successful!", "success", "update-status");
          setTimeout(() => {
            closeUpdateModal();
            // Refresh the view
            if (lastView === "search") {
              searchForm.dispatchEvent(
                new Event("submit", { cancelable: true, bubbles: true })
              );
            } else if (lastView === "all") {
              showAllBtn.click();
            }
          }, 1200);
        } catch (error) {
          setStatus(
            `Update failed: ${error.message}`,
            "error",
            "update-status"
          );
        }
      });

      cancelUpdateBtn.addEventListener("click", closeUpdateModal);
      closeModalBtn.addEventListener("click", closeUpdateModal);
      updateModal.addEventListener("click", (e) => {
        if (e.target.id === "update-modal") {
          closeUpdateModal();
        }
      });

      // --- DISPLAY & HELPER FUNCTIONS ---

      function clearResults() {
        resultsContainer.innerHTML = "";
        allTestCasesContainer.innerHTML = "";
        allTestCasesContainer.classList.add("hidden");
        noResults.classList.add("hidden");
      }

      function displayResults(results, container, isSearchResult) {
        container.innerHTML = ""; // Clear previous results
        if (results.length === 0) {
          noResults.classList.remove("hidden");
          return;
        }

        const content = results
          .map((result) => createTestCaseCard(result, isSearchResult))
          .join("");
        container.innerHTML = content;

        // Stagger animation
        const cards = container.querySelectorAll(".search-result-card");
        cards.forEach((card, index) => {
          setTimeout(() => {
            card.classList.add("visible");
          }, index * 100);
        });
      }

      function displayAllTestCases(testCases) {
        allTestCasesContainer.classList.remove("hidden");
        const formattedTestCases = testCases.map((tc) => ({
          id: tc.id,
          test_case_id: tc["Test Case ID"],
          feature: tc["Feature"],
          description: tc["Test Case Description"],
          prerequisites: tc["Pre-requisites"],
          steps: tc["Steps"],
          summary: tc.TestCaseSummary,
          keywords: tc.TestCaseKeywords,
        }));
        displayResults(formattedTestCases, allTestCasesContainer, false);
      }

      function createTestCaseCard(result, isSearchResult) {
        const resultJSON = JSON.stringify(result).replace(/'/g, "&apos;");
        const keywordBadges = (result.keywords || [])
          .map(
            (kw) =>
              `<span class="bg-slate-600 text-slate-300 text-xs font-medium mr-2 mb-2 inline-block px-2.5 py-0.5 rounded-full">${kw}</span>`
          )
          .join("");

        const matchScoreHTML = isSearchResult
          ? `
                <div class="text-center ml-4 flex-shrink-0">
                    <div class="text-2xl font-bold text-cyan-400">${Math.round(
                      result.probability
                    )}%</div>
                    <div class="text-xs text-slate-400 tracking-wider">MATCH</div>
                </div>`
          : "";

        return `
                <div class="search-result-card rounded-xl p-5">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="text-sm font-semibold text-indigo-400">${
                              result.test_case_id || "N/A"
                            }</p>
                            <h3 class="text-lg font-bold text-slate-100">${
                              result.feature || "N/A"
                            }</h3>
                            <p class="text-sm text-slate-400 mt-1">${
                              result.description || "No description."
                            }</p>
                        </div>
                        ${matchScoreHTML}
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <h4 class="text-sm font-semibold text-slate-300">AI Summary</h4>
                        <p class="text-sm text-slate-400 italic mt-1">${
                          result.summary || "No summary."
                        }</p>
                        <div class="mt-3 flex flex-wrap">${
                          keywordBadges ||
                          '<span class="text-xs text-slate-500">No keywords generated.</span>'
                        }</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-700 text-right">
                        <button class="update-btn bg-slate-600 hover:bg-slate-500 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors" data-testcase='${resultJSON}'>
                            Update
                        </button>
                    </div>
                </div>`;
      }

      function setStatus(message, type, targetId) {
        const el = document.getElementById(targetId);
        if (!el) return;

        let bgColor, textColor, icon;
        switch (type) {
          case "success":
            bgColor = "bg-green-500/10";
            textColor = "text-green-400";
            icon =
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>';
            break;
          case "error":
            bgColor = "bg-red-500/10";
            textColor = "text-red-400";
            icon =
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>';
            break;
          case "warning":
            bgColor = "bg-yellow-500/10";
            textColor = "text-yellow-400";
            icon =
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.001-1.742 3.001H4.42c-1.532 0-2.492-1.667-1.742-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>';
            break;
          default: // info
            bgColor = "bg-blue-500/10";
            textColor = "text-blue-400";
            icon =
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>';
            break;
        }
        el.innerHTML = `
                <div class="flex items-center p-3 rounded-lg text-sm ${bgColor} ${textColor}">
                    <div class="flex-shrink-0 mr-3">${icon}</div>
                    <div class="flex-grow">${message}</div>
                </div>`;
      }

      function openUpdateModal(testCase) {
        updatePointId.value = testCase.id;
        document.getElementById("update-feature").value =
          testCase.feature || "";
        document.getElementById("update-description").value =
          testCase.description || "";
        document.getElementById("update-prerequisites").value =
          testCase.prerequisites || "";
        document.getElementById("update-steps").value = testCase.steps || "";

        updateModal.classList.remove("hidden");
        updateModal.classList.remove("modal-leave");
        updateModal.classList.add("modal-enter");
        modalContent.classList.remove("modal-content-leave");
        modalContent.classList.add("modal-content-enter");
      }

      function closeUpdateModal() {
        updateModal.classList.remove("modal-enter");
        updateModal.classList.add("modal-leave");
        modalContent.classList.remove("modal-content-enter");
        modalContent.classList.add("modal-content-leave");

        setTimeout(() => {
          updateModal.classList.add("hidden");
          updateForm.reset();
          setStatus("", "", "update-status");
        }, 300); // Match animation duration
      }
    </script>
  </body>
</html>
